# 开发笔记

> 2017-07-16 16:50:59

## nodc

最近自己用 Node 写了很多的小工具，然而并不能全局使用。上网找了下答案，发现了 TJ 大神写的 Commander.js 可以很方便的制作命令行工具。于是就照着 API 把之前的 知乎专栏爬虫 给整成 CLI 工具。

### nodc 子命令

#### crawler

[x]知乎专栏爬虫

```sh
$ nodc crawler
$ nodc cr # 别名 
#直接执行会爬取 leanreact 专栏，并保存在当前文件夹下的 leanreact 和 leanreactmd 文件夹
$ nodc crawler leanreact
# 爬取 learnreact 专栏，并保存在当前文件夹下的 leanreact 和 leanreactmd 文件夹
$ nodc crawler leanreact -o ~/
# 爬取 learnreact 专栏，并保存在 home 目录下的 leanreact 和 leanreactmd 文件夹
```

#### Translation

[]有道智云翻译工具





### crawler 命令开发

#### 模块使用

**`h2m`: html 转 md 的**

```js
h2m('<h1>hello world</h1>')
```

**`fs`: 文件系统**
**`request`: http请求工具**
**`cheerio`: node 版的jq工具**
**`commander`: 命令行模块**
**`https`: https请求工具，打算换掉**

**`eventproxy`: 处理异步**

因为里面的 json2md 的 for循环经常跑在 url请求读写json文件前面，导致转换失败。
使用fs的writeStream 监听 请求是否完成，再触发 json2md。

**`shelljs`: 还没用到，这是在js中写 shell代码的模块**

#### commander

```js
var program = require('commander');

program
	.command('crawler [zhihuId]')
	.alias('cr')
	.description('🔄 知乎专栏爬虫 ⛎')
	.option('-o ,--out <path>',"🔙 输出位置")
	.action(function(zhihuId, options){
		var zhihuId = zhihuId || "leanreact";
		path =  options.out || __dirname;
		console.log('🐛   知乎专栏爬取 %s 到 %s 文件夹',zhihuId, path);
		zhihu(zhihuId,path)
	}).on('--help', function() {
    console.log('  举个例子:');
    console.log();
    console.log('    $ nodc crawler leanreact');
    console.log('    $ nodc cr leanreact -o ~/');
    console.log();
  });
program
	.parse(process.argv);
``` 

上面是 commander 模块创建 cli 命令的代码

`command`：是创建子命令的方法，可以接收两个参数
接收一个参数时，可以使用 `action` 方法在后面发起动作。
接收两个参数时，第二个参数是命令说明，后边就不能使用`action`了。
`[zhihuId]`意思是可选参数，因为我后面在`action`方法里设置了默认知乎专栏id

`alias`：子命令别名

`description`：命令摘要说明

`option`：子命令属性
我设置了输出路径属性，接收两个参数，第二个参数为命令说明
字符串中`-o`必须在`--out`前面，后面`<path>`是必填参数。

`action`：动作，顾名思义，就是发起子命令时做什么动作。
传一个匿名函数做参数，前面 command 后面括号的内容可以作为参数传入
而 option 的中括号的参数需要用`options.参数`来传入

`on`：这里设置了help的说明

`.parse(process.argv)`：没了这个命令好像不能用，这个放在所有 program 的最后

#### 处理问题

之前写知乎专栏爬虫时，爬取和处理是分开的，我使用`node 1.js&& node 2.js` 来启动的。而为了做成命令行版，我需要把这两个文件合并到 nodc 文件夹里，于是使用了朴灵大神的 eventproxy ，用writeStream来监听是否获取完成，再发起第二段代码。

#### 发布

```sh
sudo npm i -g
```